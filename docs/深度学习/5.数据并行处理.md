通过.to(device) 将模型和张量放到GPU运行，如果是多GPU，需要先用nn.DataParallel(model)包裹模型，模型会根据GPU数量将一批数据进行任务分配，批量运行。
#将模型放在一个Gpu上
device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")#指定使用的gpu
model.to(device)
#复制张量到GPU
mytensor = my_tensor.to(device) #复制一个新的my_tensor在GPU上
model = nn.DataParallel(model)#让模型并行运行在多GPU上

```python
import torch
import torch.nn as nn 
```


```python
torch.cuda.device_count() #查看gpu数量
```




    1




```python
from torch.utils.data import Dataset,DataLoader #数据集、数据加载的父类方法
#参数
input_size = 5 #数据的形状
batch_size = 30 #一批数据的数量
data_size = 100 #数据的总数量：分成三批30+10
output_size = 2
```


```python
# 实验数据生成，包装成Dataloader
class RandomDataset(Dataset):
    def __init__(self,input_size,data_size):
        self.len = data_size
        self.data = torch.randn(data_size,input_size) #生成100*5的数据
    def __getitem__(self,index):
        return self.data[index]
    def __len__(self):
        return self.len
```


```python
#定义一个模型
class Model(nn.Module):
    def __init__(self,input_size,output_size):
        super(Model,self).__init__()
        self.fc = nn.Linear(input_size,output_size) #一个线性层，输入形状为5，输出形状为2
    def forward(self,input):
        output = self.fc(input)#输入线性映射到输出
        print("\tIn Model: input_size",input.size(),"Output size",output.size())
        return output
```


```python
device = torch.device("cuda:0"if torch.cuda.is_available() else "cpu") #指定设备
#生成100个长度为5的数据，并打乱顺序，每30个为一批
rand_loader = DataLoader(dataset= RandomDataset(input_size,data_size),batch_size=batch_size,shuffle=True) 
model = Model(input_size,output_size)#创建模型
model = nn.DataParallel(model)# 当有多个GPU时，通过DataParallel包裹模型，放到多GPU上并行运行
model.to(device) #将模型放到多GPU里
#100个数据分四次在多GPU上跑完：30、30、30、10，每一批数据将会根据GPU的数量平均分配任务
#这里只有一个GPU，所以跑第一批数据时模型会期望获得30个输入和输出，若两个GPU则为每个GPU15个输入和输出
for data in rand_loader: 
    input = data.to(device) #将一批数据30*5复制后放到GPU上
    output = model(input)
    print(input)
    print(output)
```

    	In Model: input_size torch.Size([30, 5]) Output size torch.Size([30, 2])
    tensor([[ 1.3998,  1.2502, -1.1896,  0.4304, -0.4955],
            [ 0.6864,  1.9052,  1.1797,  0.4090,  0.8642],
            [ 0.7506, -1.0246, -1.6477, -0.5171, -0.0144],
            [ 1.3106, -1.5225, -0.9430,  0.3141,  1.9123],
            [ 1.0573, -0.2924,  0.8618,  0.4295, -0.7217],
            [ 0.3638,  0.0907,  1.6479,  0.1283, -1.3053],
            [ 1.2924, -0.3428,  0.6310,  0.4793,  0.6701],
            [ 1.8357,  0.7652, -1.8002, -0.1317,  1.6598],
            [-0.6599,  0.7767,  1.0053,  0.1474,  0.5814],
            [ 0.8478,  0.6015,  0.5130, -0.0224,  0.8288],
            [-0.2636, -0.3118, -0.2701, -0.9767, -0.2967],
            [ 0.7115,  1.7632,  0.1660, -0.6052, -0.5283],
            [-0.6665,  1.2859, -0.3946, -0.4079, -0.3478],
            [ 0.0567,  0.4262,  1.2631, -0.4811, -0.9828],
            [ 0.4011, -0.0245, -0.4672, -1.5755, -0.5582],
            [ 0.4740, -1.6728, -0.2675,  0.9257, -0.1911],
            [ 0.2513,  0.8764, -1.0027,  0.0539, -0.6720],
            [-1.7727,  0.8830,  0.3481, -0.1401, -1.1334],
            [ 1.7107,  0.0463,  0.7738,  0.9380, -1.3504],
            [ 0.5126, -0.3576, -1.2318,  1.0766,  0.9749],
            [-1.0016, -1.6359,  0.0756,  0.1361,  0.7690],
            [-0.4070, -0.9672,  0.0666, -1.5400, -0.2621],
            [ 2.0251,  0.0809, -0.1042, -0.0352,  2.4577],
            [ 0.4857, -0.4238,  0.2555, -0.3199,  1.7891],
            [-0.8048, -0.1197, -0.2343, -0.4379, -0.2754],
            [-1.1243, -0.8615, -0.4208, -0.8382, -3.2918],
            [-1.3045,  0.3495,  1.7364, -0.8862,  0.1597],
            [ 1.0946,  1.1148, -0.1790, -1.4312,  1.0513],
            [-2.2245,  1.3228, -0.7857, -0.5271, -0.7456],
            [ 0.6569,  1.6206, -2.2606,  1.5304,  0.1448]], device='cuda:0')
    tensor([[ 1.3354, -0.4408],
            [ 1.5101,  0.1422],
            [ 0.2464, -0.6226],
            [ 0.5474, -0.4104],
            [ 0.5074, -0.4467],
            [ 0.3219, -0.3651],
            [ 0.7759, -0.2624],
            [ 1.5503, -0.1377],
            [ 0.6384, -0.1048],
            [ 1.0098, -0.0566],
            [ 0.1108, -0.3593],
            [ 1.1840, -0.0599],
            [ 0.6992, -0.2681],
            [ 0.3742, -0.2307],
            [ 0.3070, -0.2558],
            [-0.0172, -0.8141],
            [ 0.8059, -0.4891],
            [ 0.1222, -0.4482],
            [ 0.7791, -0.5618],
            [ 0.7514, -0.5913],
            [-0.3483, -0.5526],
            [-0.2580, -0.3179],
            [ 1.3869,  0.1021],
            [ 0.6292, -0.0529],
            [ 0.1026, -0.4376],
            [-0.7701, -0.9900],
            [ 0.0914,  0.0023],
            [ 1.1931,  0.2047],
            [ 0.2431, -0.4285],
            [ 1.5453, -0.6408]], device='cuda:0', grad_fn=<AddmmBackward0>)
    	In Model: input_size torch.Size([30, 5]) Output size torch.Size([30, 2])
    tensor([[-9.5780e-01, -7.5886e-01,  1.9236e-02, -4.8388e-01,  1.0122e+00],
            [ 1.6689e-01, -1.1247e+00,  2.2246e-01,  1.6482e+00, -6.9651e-01],
            [-1.0487e+00, -1.6386e-01, -2.1590e+00,  2.3110e-01, -1.8020e-01],
            [ 3.1493e-04,  7.0393e-01,  2.0773e-01,  9.8784e-01,  1.0538e+00],
            [-6.3951e-01,  6.3711e-01,  1.4174e+00, -1.2572e+00, -1.7681e-01],
            [-2.1382e+00,  4.3187e-01,  1.1226e+00,  1.8231e+00, -1.7205e+00],
            [-8.4624e-01,  1.4595e+00,  1.0381e+00, -6.9887e-01, -2.4990e+00],
            [-1.6691e+00, -9.8542e-01,  4.3054e-01,  1.6838e-01, -1.5251e-01],
            [-1.8630e-01,  6.1140e-01, -7.0218e-01,  1.2116e-01, -4.1111e-01],
            [-5.8279e-01,  1.0899e+00, -1.0506e+00,  2.7525e-01,  2.3481e-01],
            [ 1.8877e-01,  3.5218e-02, -6.2246e-01, -1.1856e+00,  2.9768e-01],
            [ 7.6280e-01,  1.7437e+00, -1.6927e-01,  2.0591e+00, -1.9448e-01],
            [ 8.4804e-01,  1.8089e+00,  1.4965e+00,  1.4096e+00,  6.3428e-01],
            [-7.2712e-01,  5.4424e-01,  4.9631e-01, -1.5711e+00,  7.6291e-02],
            [ 1.6211e-01, -3.4816e-01, -5.0712e-01,  5.1419e-01,  3.6964e-02],
            [-1.1377e+00, -2.0432e-01,  8.8319e-01, -8.7732e-02, -3.8484e-01],
            [-2.5830e+00,  7.7596e-01,  1.3320e-01,  1.2762e-01, -1.6620e-01],
            [-1.2100e+00,  2.6715e-01,  1.2773e-01, -1.5132e+00,  1.7489e-01],
            [ 1.5924e+00, -5.8187e-01,  2.4304e-02, -4.7442e-01, -8.8907e-01],
            [ 1.4525e+00,  1.7149e+00, -1.2975e+00,  1.2307e+00, -8.4815e-01],
            [-4.3457e-01, -1.1473e+00,  3.2537e-01, -1.5696e+00,  1.1417e-02],
            [-3.5440e-01,  8.9465e-01, -1.8591e-01, -5.5836e-01,  8.2611e-01],
            [-8.4165e-01, -9.4987e-01, -8.5853e-01, -3.6496e-01, -9.8048e-01],
            [-1.1483e+00, -1.1356e-01,  4.1353e-02, -1.3213e+00, -1.8714e-01],
            [-6.9137e-01, -1.1348e-01,  4.2108e-02,  1.9132e+00,  1.8538e+00],
            [ 7.6306e-01,  1.2829e+00,  1.1593e+00, -7.1834e-01,  6.2651e-01],
            [-3.4217e-01, -6.3654e-01,  4.7631e-01, -1.0224e+00, -1.7735e+00],
            [-1.5070e+00, -1.9161e-01,  1.0612e+00,  3.4664e-01,  1.3255e+00],
            [ 5.3883e-01,  1.9607e+00,  1.4431e+00,  1.0221e+00,  3.6899e+00],
            [ 4.4198e-01,  4.5949e-01,  3.6734e-02, -7.2834e-01,  3.8322e-01]],
           device='cuda:0')
    tensor([[-0.0137, -0.2931],
            [ 0.0995, -0.8851],
            [ 0.1875, -0.7985],
            [ 0.9801, -0.2512],
            [ 0.3060,  0.0410],
            [-0.0674, -0.8438],
            [ 0.3029, -0.3569],
            [-0.4176, -0.5952],
            [ 0.6177, -0.4783],
            [ 0.8322, -0.3975],
            [ 0.4522, -0.2068],
            [ 1.5388, -0.4885],
            [ 1.5732, -0.0235],
            [ 0.2896, -0.0039],
            [ 0.4291, -0.5676],
            [-0.0463, -0.3954],
            [ 0.0482, -0.4208],
            [ 0.0873, -0.1074],
            [ 0.4480, -0.4491],
            [ 1.5713, -0.5729],
            [-0.3099, -0.2636],
            [ 0.7791, -0.0733],
            [-0.3110, -0.7607],
            [-0.0789, -0.2582],
            [ 0.6969, -0.4472],
            [ 1.1268,  0.2023],
            [-0.3000, -0.5372],
            [ 0.1584, -0.1904],
            [ 1.9754,  0.5204],
            [ 0.7226, -0.1112]], device='cuda:0', grad_fn=<AddmmBackward0>)
    	In Model: input_size torch.Size([30, 5]) Output size torch.Size([30, 2])
    tensor([[ 0.3781,  2.1261, -0.3597,  0.3549, -2.1107],
            [-0.0709, -1.4302,  1.4230,  0.8944, -1.1881],
            [-0.9975,  0.3456, -0.2782,  0.2082, -0.2557],
            [-1.8932,  0.4349,  0.8883, -1.1904, -1.5182],
            [ 0.3455,  0.5789, -2.3086, -0.8742,  1.1737],
            [ 0.0169, -0.5500, -0.7310, -0.0464,  1.1175],
            [-0.1645, -0.5905,  0.9990, -0.6432,  0.7527],
            [ 0.5220, -0.4567,  1.1042, -0.8809,  0.5406],
            [-0.1422, -0.5740,  0.3312, -0.7692,  1.6345],
            [ 0.1451,  0.0947,  0.8352, -0.7859,  1.8668],
            [ 1.9446, -1.3905,  0.2506,  0.9803,  0.2194],
            [ 0.0615,  1.3827, -0.0128, -0.4939, -0.2779],
            [-1.1412,  1.1279, -2.0840,  1.1058,  0.2850],
            [ 1.2718, -0.8321, -0.4539, -0.1579,  0.9745],
            [ 1.1226,  1.0046,  0.8519, -0.8238,  0.1195],
            [-0.7281,  0.0879, -1.3753,  1.2879,  0.4902],
            [ 0.5696,  0.2200, -0.3299,  0.1004,  0.1422],
            [-1.5161, -0.8023, -1.0319, -0.2165,  0.7449],
            [-1.5832, -1.6690, -0.9242,  0.9560, -1.0835],
            [ 0.7799,  1.5120, -0.8574,  0.8296,  0.4161],
            [-0.6846,  0.8758, -0.1340,  0.2472,  0.0223],
            [-0.4372, -1.2618, -0.1331,  1.4128,  0.4364],
            [-0.7120, -0.3535, -1.2841, -0.2905, -0.2255],
            [ 1.2310,  0.9690,  0.3350,  0.6503,  0.8104],
            [ 1.2663,  0.5659,  0.3049, -0.4675,  0.6860],
            [ 0.9824, -0.4866,  1.1276,  0.3263, -0.4636],
            [-1.2399, -1.2226,  0.5335, -0.2183, -1.0702],
            [-0.1033,  2.6522, -0.6016,  1.9526,  0.5291],
            [ 1.4843,  1.3897,  0.2812, -0.2434, -1.1302],
            [ 0.3419, -0.3271, -1.0362,  0.0159,  0.6600]], device='cuda:0')
    tensor([[ 1.1250, -0.4977],
            [-0.2915, -0.7381],
            [ 0.3107, -0.4889],
            [-0.2819, -0.3359],
            [ 0.9483, -0.2534],
            [ 0.4234, -0.3703],
            [ 0.1667, -0.1205],
            [ 0.3407, -0.0503],
            [ 0.3276, -0.0441],
            [ 0.6829,  0.1686],
            [ 0.5326, -0.5833],
            [ 0.9167, -0.1462],
            [ 0.8389, -0.6798],
            [ 0.5993, -0.3206],
            [ 1.0364,  0.0774],
            [ 0.5543, -0.7148],
            [ 0.7285, -0.3606],
            [-0.1469, -0.5467],
            [-0.6670, -1.1388],
            [ 1.4415, -0.3118],
            [ 0.6457, -0.3431],
            [ 0.0457, -0.7619],
            [ 0.1018, -0.6184],
            [ 1.3349, -0.1229],
            [ 1.0467, -0.0185],
            [ 0.4269, -0.3861],
            [-0.5827, -0.6764],
            [ 1.7875, -0.3241],
            [ 1.1831, -0.2163],
            [ 0.5490, -0.4450]], device='cuda:0', grad_fn=<AddmmBackward0>)
    	In Model: input_size torch.Size([10, 5]) Output size torch.Size([10, 2])
    tensor([[ 0.9590,  0.2783,  0.0272,  0.3649, -0.2138],
            [-1.0221,  1.1539, -0.0216, -1.3887, -1.1672],
            [-0.8936,  0.5761, -0.0550,  0.1512,  0.1143],
            [-1.2700, -1.3692, -1.1519,  0.2763, -0.7863],
            [-1.0240,  0.0134, -1.4516,  1.6743,  1.0821],
            [ 0.0467, -0.4071,  1.1326,  0.3910, -0.5588],
            [-0.6852,  0.4864, -0.4666,  1.8307, -2.5082],
            [ 0.0563, -0.5627,  0.4909,  0.7415,  1.0557],
            [-0.1177,  0.9946, -0.6947,  1.1342,  1.8939],
            [-0.3377,  1.6454,  0.2866, -0.5777,  0.7929]], device='cuda:0')
    tensor([[ 0.8144, -0.3875],
            [ 0.3073, -0.2230],
            [ 0.4709, -0.3550],
            [-0.4820, -0.9528],
            [ 0.5800, -0.7194],
            [ 0.2019, -0.4431],
            [ 0.2897, -1.0988],
            [ 0.4517, -0.3516],
            [ 1.2458, -0.2239],
            [ 1.0559,  0.0932]], device='cuda:0', grad_fn=<AddmmBackward0>)
    
